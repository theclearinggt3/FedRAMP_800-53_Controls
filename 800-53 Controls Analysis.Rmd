---
title: "800-53 Controls"
output: pdf_document
---

#If packages are not installed on your computer, need to uncomment and install the following packages. 
#install.packages("readxl")
#install.packages("readr")
#install.packages("tidyverse")
#install.packages("ggplot2")
install.packages("igraph")


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(readr)
library(tidyverse)
library(ggplot2)
library(igraph)
```

##1. 800-53 subcontrol relations
This spreadsheet is a web-scrape of 800-53 detail for the FedRAMP High Baseline (~170 controls) with sub-control detail. Column A displays the main control. Column B displays the subcontrol (or enhancement). (Example: Row 2 is AC-2(4) which is an individual subcontrol of AC-2, so on and so forth). Column C shows the related controls for each subcontrol.

Could you work with this data set so that it can be more easily manipulated and come up with any detail you can surmise. Things that would be great to understand are:
- Count (#) of related controls for each subcontrol
- Most important related controls - by count / frequency
- Most important related controls - by co-occurence 
- Most important subcontrols - by count of related controls and co-occurrence
- Most important control families - by count of related controls / ratio of subcontrols

I'm going to give you creative license here. If anything doesnt make sense, feel free to ask Dan or I but don't get too into the weeds.

##2. controls_4.xlsx
This is a spreadsheet I have had some fun with already. Could you help organize the first worksheet which shows the related controls for each control in the high baseline. Column A shows the control. Columns B --> AB show the related controls for that control. 

Think of the first sheet as granular detail to the second spreadsheet. 


Reading in the data set. It is the third version, last edited on June 13th. 
```{r}
#File path for Eugene Hwang
#Controls <- read_excel("/Users/eugenehwang/Documents/GitHub/FedRAMP_800-53_Controls/800-53 subcontrol relations.xlsx")

#Set working directory path
#setwd("/Users/eugenehwang/Documents/FedRAMP/Data")
setwd("/Users/eugenehwang/Documents/GitHub/FedRAMP_800-53_Controls")

#Get working directory path
getwd()


Controls <- read_excel("~/Desktop/The Clearing/800-53 subcontrol relations v3.xlsx")
head(Controls)
```


#Data Cleaning  

Filtering through the data set to analyze the high baseline controls. 
```{r}
HighControls <- Controls %>%
  filter(High == "Y") %>% #filtering to High Baseline 
  rename(`Control Family` = Family) %>% #renaming the Family variable to Control Family
  select(`Control Family`, `Main Control`, `Control Enhancement`, Combined, `Related Controls`) 

head(HighControls)
```

##High Control 1
    
Spreading Related Controls into different columns. 
```{r warning = FALSE}
HighControls1 <- HighControls %>%
  select(-`Control Enhancement`) %>%
  separate('Related Controls', paste("Related Control", 1:28, sep = " "),
           sep = ",", 
           extra = "warn") %>% #spreading Related Controls into different columns 
  mutate(`Related Control 1` = str_trim(`Related Control 1`, side = "both"),
         `Related Control 2` = str_trim(`Related Control 2`, side = "both"),
         `Related Control 3` = str_trim(`Related Control 3`, side = "both"),
         `Related Control 4` = str_trim(`Related Control 4`, side = "both"),
         `Related Control 5` = str_trim(`Related Control 5`, side = "both"),
         `Related Control 6` = str_trim(`Related Control 6`, side = "both"),
         `Related Control 7` = str_trim(`Related Control 7`, side = "both"),
         `Related Control 8` = str_trim(`Related Control 8`, side = "both"),
         `Related Control 9` = str_trim(`Related Control 9`, side = "both"),
         `Related Control 10` = str_trim(`Related Control 10`, side = "both"),
         `Related Control 11` = str_trim(`Related Control 11`, side = "both"),
         `Related Control 12` = str_trim(`Related Control 12`, side = "both"),
         `Related Control 13` = str_trim(`Related Control 13`, side = "both"),
         `Related Control 14` = str_trim(`Related Control 14`, side = "both"),
         `Related Control 15` = str_trim(`Related Control 15`, side = "both"),
         `Related Control 16` = str_trim(`Related Control 16`, side = "both"),
         `Related Control 17` = str_trim(`Related Control 17`, side = "both"),
         `Related Control 18` = str_trim(`Related Control 18`, side = "both"),
         `Related Control 19` = str_trim(`Related Control 19`, side = "both"),
         `Related Control 20` = str_trim(`Related Control 20`, side = "both"),
         `Related Control 21` = str_trim(`Related Control 21`, side = "both"),
         `Related Control 22` = str_trim(`Related Control 22`, side = "both"),
         `Related Control 23` = str_trim(`Related Control 23`, side = "both"),
         `Related Control 24` = str_trim(`Related Control 24`, side = "both"),
         `Related Control 25` = str_trim(`Related Control 25`, side = "both"),
         `Related Control 26` = str_trim(`Related Control 26`, side = "both"),
         `Related Control 27` = str_trim(`Related Control 27`, side = "both"),
         `Related Control 28` = str_trim(`Related Control 28`, side = "both")) #removing empty spaces in those variable's values. Not the smartest way of coding but does the job. 

head(HighControls1)
```   
   
##High Controls 2   
    
Spreading Related Control into different columns and gathering the control enhancement by main controls (removing the control enhancement detail). 
```{r warning = FALSE}
HighControls2 <- HighControls %>%
  select(-`Control Enhancement`, -Combined) %>%
  separate(`Related Controls`, paste("Related Control", 1:28, sep = " "),
           sep = ",", 
           extra = "warn") %>% #spreading Related Controls into different columns 
  gather(AllRelatedControls, Value, 
         `Related Control 1`:`Related Control 28`, na.rm = TRUE) %>%
  group_by(`Main Control`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>% 
  ungroup() %>%
  select(-AllRelatedControls) %>%
  spread(AllRelatedControls2, Value, convert = TRUE) %>% 
  select(`Control Family`, `Main Control`, `Related Control 1`, `Related Control 2`, `Related Control 3`, 
         `Related Control 4`, `Related Control 5`, `Related Control 6`, `Related Control 7`, `Related Control 8`, 
         `Related Control 9`, `Related Control 10`, `Related Control 11`, `Related Control 12`, 
         `Related Control 13`, `Related Control 14`, `Related Control 15`, `Related Control 16`, 
         `Related Control 17`, `Related Control 18`, `Related Control 19`, `Related Control 20`, 
         `Related Control 21`, `Related Control 22`, `Related Control 23`, `Related Control 24`, 
         `Related Control 25`, `Related Control 26`, `Related Control 27`, `Related Control 28`, 
         `Related Control 29`, `Related Control 30`, `Related Control 31`, `Related Control 32`, 
         `Related Control 33`, `Related Control 34`, `Related Control 35`, `Related Control 36`, 
         `Related Control 37`) %>% #reording the variables in the table 
    mutate(`Related Control 1` = str_trim(`Related Control 1`, side = "both"),
         `Related Control 2` = str_trim(`Related Control 2`, side = "both"),
         `Related Control 3` = str_trim(`Related Control 3`, side = "both"),
         `Related Control 4` = str_trim(`Related Control 4`, side = "both"),
         `Related Control 5` = str_trim(`Related Control 5`, side = "both"),
         `Related Control 6` = str_trim(`Related Control 6`, side = "both"),
         `Related Control 7` = str_trim(`Related Control 7`, side = "both"),
         `Related Control 8` = str_trim(`Related Control 8`, side = "both"),
         `Related Control 9` = str_trim(`Related Control 9`, side = "both"),
         `Related Control 10` = str_trim(`Related Control 10`, side = "both"),
         `Related Control 11` = str_trim(`Related Control 11`, side = "both"),
         `Related Control 12` = str_trim(`Related Control 12`, side = "both"),
         `Related Control 13` = str_trim(`Related Control 13`, side = "both"),
         `Related Control 14` = str_trim(`Related Control 14`, side = "both"),
         `Related Control 15` = str_trim(`Related Control 15`, side = "both"),
         `Related Control 16` = str_trim(`Related Control 16`, side = "both"),
         `Related Control 17` = str_trim(`Related Control 17`, side = "both"),
         `Related Control 18` = str_trim(`Related Control 18`, side = "both"),
         `Related Control 19` = str_trim(`Related Control 19`, side = "both"),
         `Related Control 20` = str_trim(`Related Control 20`, side = "both"),
         `Related Control 21` = str_trim(`Related Control 21`, side = "both"),
         `Related Control 22` = str_trim(`Related Control 22`, side = "both"),
         `Related Control 23` = str_trim(`Related Control 23`, side = "both"),
         `Related Control 24` = str_trim(`Related Control 24`, side = "both"),
         `Related Control 25` = str_trim(`Related Control 25`, side = "both"),
         `Related Control 26` = str_trim(`Related Control 26`, side = "both"),
         `Related Control 27` = str_trim(`Related Control 27`, side = "both"),
         `Related Control 28` = str_trim(`Related Control 28`, side = "both")) #removing empty spaces in those variable's values. Not the smartest way of coding but does the job.

head(HighControls2)
```    
    
##High Controls 3

Similar to HighControls1 but reformatted to make it easier to read, manipulate, and analyze.
```{r}
HighControls3 <- HighControls1 %>%
  gather(AllRelatedControls, Value, `Related Control 1`:`Related Control 28`, na.rm = TRUE) %>%
  group_by(`Main Control`, `Combined`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>%
  rename(`Related Controls` = `Value`) %>%
  select(-`AllRelatedControls`, -`AllRelatedControls2`) %>%
  ungroup() %>%
  arrange(`Main Control`, `Combined`) 

head(HighControls3)
```
     
##High Controls 4   
      
Similar to HighControls2 but reformatted to make it easier to manipulate. 
```{r}
HighControls4 <- HighControls1 %>%
  select(-`Combined`) %>%
  gather(AllRelatedControls, Value, `Related Control 1`:`Related Control 28`, na.rm = TRUE) %>%
  group_by(`Main Control`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>%
  rename(`Related Controls` = `Value`) %>%
  select(-`AllRelatedControls`, -`AllRelatedControls2`) %>%
  ungroup() %>%
  arrange(`Main Control`) 

head(HighControls4)
```
    
        
#Data Analysis      
   
**1. Most important Related Controls - by count / frequency**
```{r}
CountRC <- HighControls3 %>%
  group_by(`Related Controls`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

head(CountRC)

write_csv(CountRC, "CountRC.csv") #exporting CountRC into a csv file called CountRC.csv into your directory. 

#TESTING

#Number of times Related Controls = "AC-3" exists? 
#Answer = 29
HighControls3 %>%
  filter(`Related Controls` == 'AC-3')    
   
#VISUAL

CountRC %>%
  filter(n_RelatedControls >= 10) %>%
  ggplot(aes(reorder(`Related Controls`, -n_RelatedControls), n_RelatedControls)) + 
  geom_bar(stat = "identity") + 
  ggtitle("Most Important Related Controls based on Count") +
    xlab("Top 21 Related Controls") + 
    ylab("Number of Related Controls")
```

**2. Number of Related Controls for Control** 
#Can also be considered as most important Controls - by count of Related Control
```{r}

CountRC_CE <- HighControls3 %>%
  group_by(`Combined`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

head(CountRC_CE)

write_csv(CountRC_CE, "CountRC_CE.csv") #exporting CountRC_CE into a csv file called CountRC_CE.csv into your directory. 

#TESTING

#How many Related Controls are there when the Main Control = "AU-6" and the Control Enhancement = "0"? 
#Answer = 28
HighControls3 %>%
  filter(`Combined` == 'AU-6-0')

#VISUAL

CountRC_CE %>%
  filter(n_RelatedControls >= 15) %>%
  ggplot(aes(reorder(`Combined`, -n_RelatedControls), n_RelatedControls)) +
    geom_bar(stat = "identity") + 
    ggtitle("Largest Amount of Related Controls for each Control") +
    xlab("Top 11 Controls") + 
    ylab("Number of Related Controls")
```

**3. Number of Related Controls for each Main Control** FIX VISUAL
```{r}
CountRC_MC <- HighControls3 %>%
  group_by(`Main Control`, `Related Controls`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

head(CountRC_MC)  
  
write_csv(CountRC_MC, "CountRC_MC.csv") #exporting CountRC_MC into a csv file called CountRC_MC.csv into your directory. 

#TESTING

#Number of Related Controls when Related Controls = "AU-12" and Main Control = "AU-6"? 
#Answer = 4
HighControls3 %>%
  filter(`Related Controls` == 'AU-12', 
         `Main Control` == 'AU-6')

#VISUAL

#CountRC_MC %>%
#  filter(n_RelatedControls > 1) %>%
#  ggplot(aes(reorder(`Main Control`, -n_RelatedControls), n_RelatedControls)) +
#    geom_point() +
#    geom_text(aes(label = `Related Controls`), size = 3, check_overlap = TRUE) + 
#    ggtitle("Largest Amount of Related Controls for each Main Control") +
#    xlab("Top 16 Main Controls") + 
#    ylab("Number of Related Controls")
```

**4. Number of Related Controls for each Control Family** FIX VISUAL AND RECHECK ANALYSIS
```{r}
CountRC_CF <- HighControls3 %>%
  group_by(`Control Family`, `Related Controls`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

head(CountRC_CF)

write_csv(CountRC_CF, "CountRC_CF.csv") #exporting CountRC_CF into a csv file called CountRC_CF.csv into your directory. 

#TESTING

#Number of Related Controls when Related Controls = "AC-3" and Control Family = "AC"? 
#Answer = 11
HighControls3 %>%
  filter(`Related Controls` == 'AC-3', 
         `Control Family` == 'AC')   
  
#VISUAL

#CountRC_CF %>%
#  filter(n_RelatedControls > 1) %>%
#  ggplot(aes(reorder(`Control Family`, -n_RelatedControls), n_RelatedControls)) +
#    geom_point() +
#    geom_text(aes(label = `Related Controls`), size = 3, check_overlap = TRUE) + 
#    ggtitle("Number of Related Controls for each Control Family") +
#    xlab("Top 16 Control Family") + 
#    ylab("Number of Related Controls")
```    

**5. Most important Related Controls - by co-occurence** 
MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX 

**6. Most important Controls - by co-occurrence** 
MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX MATRIX 

**7. Most important Control Families - by count of Related Controls / ratio of Controls** MUST FINISH TESTING & VISUALS FOR RATIO
```{r}
##By count of Related Controls 
CountCF <- HighControls3 %>%
  group_by(`Control Family`) %>%
  summarise(n_ControlFamily = n()) %>%
  arrange(desc(n_ControlFamily))

head(CountCF)

write_csv(CountCF, "CountCF.csv") #exporting CountCF into a csv file called CountCF.csv into your directory. 

#TESTING  
    
#Number of Related Controls when Control Family = "AC"? 
#Answer = 162
HighControls3 %>%
  filter(`Control Family` == 'AC')

#VISUAL

CountCF %>%
  #filter(n_ControlFamily >= 15) %>%
  ggplot(aes(reorder(`Control Family`, -n_ControlFamily), n_ControlFamily)) +
    geom_bar(stat = "identity") +
    #geom_text(aes(label = `Related Controls`), size = 3, check_overlap = TRUE) + 
    ggtitle("Number of Related Controls for each Control Family") +
    xlab("Control Families") + 
    ylab("Number of Related Controls")   
   
#################################################################################################

##By ratio of Controls 
CountCFRatio <- HighControls3 %>%
  mutate(n_TotalControls = n_distinct(`Combined`)) %>%
  group_by(`Control Family`) %>%
  mutate(n_Controls_by_Fam = n_distinct(`Combined`),
         Ratio_Controls = n_Controls_by_Fam/n_TotalControls) %>% 
  arrange(desc(Ratio_Controls))

head(CountCFRatio)

write_csv(CountCFRatio, "CountCFRatio.csv") #exporting CountCFRatio into a csv file called CountCFRatio.csv into your directory. 

#TESTING

#VISUAL

#CountCFRatio %>%
#  filter(n_ControlFamily >= 15) %>%
#  ggplot(aes(reorder(`Control Family`, -n_ControlFamily), n_ControlFamily)) +
#    geom_bar(stat = "identity") +
#    geom_text(aes(label = `Related Controls`), size = 3, check_overlap = TRUE) + 
#    ggtitle("Number of Related Controls for each Control Family") +
#    xlab("Control Families") + 
#    ylab("Number of Related Controls")
```


**Eugene's Data Cleaning for Gephi
Selecting only the needed columns
```{r}
names(Controls) <- c("Control_Family","Family_Name","Control_Name", "Main_Control","Control_Enhancement_Name", "Control_Enhancement","Combined","Related_Controls","Low","Low_2","Medium","Medium_2","High","High_2","Priority","Impact")

Gephi_Controls <- Controls %>%
  select(Control_Family, Family_Name, Main_Control, Control_Name, Control_Enhancement, Combined, Related_Controls, Low, Medium, High, Impact) 

```


**8a. Network Analysis - Gephi** 
```{r}
#Create Node Table
Gephi_node <- distinct(HighControls3,Combined)

#Renaming columns to ID
names(Gephi_node) <- c("ID")

#Create Edges Table
Gephi_edges <- select(HighControls3, Combined, "Related Controls")

#Renaming columns to Source and Target
names(Gephi_edges) <- c("Source","Target")

#Write to CSV
write_csv(Gephi_node, "Gephi_node.csv") #exporting the Node file into a csv file called Gephi_node.csv into your working directory you set earlier.

write_csv(Gephi_edges, "Gephi_edges.csv") #exporting the Edge file into a csv file called Gephi_edges.csv into your working directory you set earlier.
```

**8b. Network Analysis - iGraph** 
```{r}
#Create Node Table
HighControls3_eh <- HighControls3

names(HighControls3_eh) <- c("Control_Family","Main_Control","Combined","Related_Controls")

Nodes_temp_MC <- distinct(HighControls3_eh, Main_Control)
names(Nodes_temp_MC)<- c("id")

Nodes_temp_RC <- distinct(HighControls3_eh, Related_Controls)
names(Nodes_temp_RC)<- c("id")

#Selecting disctinct Nodes
Nodes_temp_wo_name <- distinct(rbind(Nodes_temp_MC,Nodes_temp_RC),id)

#Adding Name (labels)
Nodes = cbind(Nodes_temp_wo_name,Name=rep(Nodes_temp_wo_name$id))

#Delete temp tables
rm(Nodes_temp_MC)
rm(Nodes_temp_RC)
rm(Nodes_temp_wo_name)

#Write to CSV
write_csv(Nodes, "Nodes.csv") #exporting the Node file into a csv file called Nodes.csv into your working directory you set earlier.

#***

#Create Edges Table
Edges <- select(HighControls3_eh, Main_Control, Related_Controls)

#Renaming columns to Source and Target
names(Edges) <- c("from","to")

#Write to CSV
write_csv(Edges, "Edges.csv") #exporting the Edge file into a csv file called Edges.csv into your working directory you set earlier.

#Turning Networks into igraph objects
net <- graph_from_data_frame(d=Edges, vertices=Nodes, directed=T) 

#Nodes and Edges
E(net)       # The edges of the "net" object
V(net)       # The vertices of the "net" object

#Plotting graph
plot(net, edge.arrow.size=.2, edge.curved=0,
     vertex.color="orange", vertex.frame.color="#555555",
     vertex.label=V(net)$media, vertex.label.color="black",
     vertex.label.cex=.7) 
     
#Transitivity
# A measure of social process such that friends of friends will become friends. A high transitivity measure indicates a tightly
# knit collaborative environment (clique), while a low transitivity measure indicates that neighboring researchers do not collaborate
# with each other (star).

transitivity(net, vids = "SC-26", type="local")
transitivity(net, type="local")
```

**9. Bar Chart** 

Control_High_Counts_by_Family <- Controls %>%
  filter(High == "Y") %>%
  group_by(Family) %>%
  summarise(n=n())
  

Control_High_Counts_by_Family %>%
  filter(High == "Y") %>%
  group_by(test_vec) %>%
  summarise(n = n())
























