---
title: "800-53 Controls"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
```

##1. 800-53 subcontrol relations
This spreadsheet is a web-scrape of 800-53 detail for the FedRAMP High Baseline (~170 controls) with sub-control detail. Column A displays the main control. Column B displays the subcontrol (or enhancement). (Example: Row 2 is AC-2(4) which is an individual subcontrol of AC-2, so on and so forth). Column C shows the related controls for each subcontrol.

Could you work with this data set so that it can be more easily manipulated and come up with any detail you can surmise. Things that would be great to understand are:
- Count (#) of related controls for each subcontrol
- Most important related controls - by count / frequency
- Most important related controls - by co-occurence 
- Most important subcontrols - by count of related controls and co-occurrence
- Most important control families - by count of related controls / ratio of subcontrols

I'm going to give you creative license here. If anything doesnt make sense, feel free to ask Dan or I but don't get too into the weeds.

##2. controls_4.xlsx
This is a spreadsheet I have had some fun with already. Could you help organize the first worksheet which shows the related controls for each control in the high baseline. Column A shows the control. Columns B --> AB show the related controls for that control. 

Think of the first sheet as granular detail to the second spreadsheet. 


#Data Cleaning  
  
```{r}
Controls <- read_excel("~/Desktop/800-53/800-53 subcontrol relations.xlsx")
head(Controls)
```

```{r warning = FALSE}
#separating Main Control to get the Control Family variable
Controls1 <- Controls %>%
  mutate(`Control Family` = `Main Control`) %>%
  separate(`Control Family`, 
           into = c("Control Family", "Control"), 
           sep = "-") %>%
  select(`Control Family`, `Main Control`, `Control Enhancement`, `Related Controls`)

head(Controls1)

#spreading Related Controls into different columns 
Controls2 <- Controls1 %>%
  separate('Related Controls', paste("Related Control", 1:8, sep = " "), sep = ",", extra = "warn")

View(Controls2)
```

```{r warning = FALSE}
Controls3 <- Controls1 %>%
  select(-`Control Enhancement`) %>%
  separate('Related Controls', paste("Related Control", 1:8, sep = " "), sep = ",", extra = "warn") %>%
  gather(AllRelatedControls, Value, `Related Control 1`:`Related Control 8`, na.rm = TRUE) %>%
  group_by(`Main Control`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>% 
  ungroup() %>%
  select(-AllRelatedControls) %>%
  spread(AllRelatedControls2, Value, convert = TRUE) %>%
  select(`Control Family`, `Main Control`, `Related Control 1`, `Related Control 2`, `Related Control 3`, 
         `Related Control 4`, `Related Control 5`, `Related Control 6`, `Related Control 7`, `Related Control 8`, 
         `Related Control 9`, `Related Control 10`, `Related Control 11`, `Related Control 12`, 
         `Related Control 13`, `Related Control 14`, `Related Control 15`, `Related Control 16`, 
         `Related Control 17`, `Related Control 18`, `Related Control 19`, `Related Control 20`, 
         `Related Control 21`, `Related Control 22`, `Related Control 23`, `Related Control 24`, 
         `Related Control 25`)  

View(Controls3)
```

Similar to Controls2 but reformatted to make it easier to manipulate. 
```{r}
Controls4 <- Controls1 %>%
  separate('Related Controls', paste("Related Control", 1:8, sep = " "), sep = ",", extra = "warn") %>%
  gather(AllRelatedControls, Value, `Related Control 1`:`Related Control 8`, na.rm = TRUE) %>%
  group_by(`Main Control`, `Control Enhancement`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>%
  rename(`Related Controls` = `Value`) %>%
  select(-`AllRelatedControls`, -`AllRelatedControls2`) %>%
  ungroup() %>%
  arrange(`Main Control`, `Control Enhancement`) 

Controls4
```

Similar to Controls3 but reformatted to make it easier to manipulate. 
```{r}
Controls5 <- Controls1 %>%
  select(-`Control Enhancement`) %>%
  separate('Related Controls', paste("Related Control", 1:8, sep = " "), sep = ",", extra = "warn") %>%
  gather(AllRelatedControls, Value, `Related Control 1`:`Related Control 8`, na.rm = TRUE) %>%
  group_by(`Main Control`) %>%
  mutate(AllRelatedControls2 = paste("Related Control", 1:n(), sep = " ")) %>%
  rename(`Related Controls` = `Value`) %>%
  select(-`AllRelatedControls`, -`AllRelatedControls2`) %>%
  ungroup() %>%
  arrange(`Main Control`) 

Controls5
```

**Number of related controls for each subcontrol (Control Enhancement)** 
```{r}
#Controls4

CountRCCE <- Controls4 %>%
  group_by(`Main Control`, `Control Enhancement`) %>%
  summarise(n_RelatedControls = n())

CountRCCE

#TESTING
#How many Related Controls are there when the Main Control = "AC-17" and the Control Enhancement = "1"? 
#Answer = 2
Controls4 %>%
  filter(`Main Control` == "AC-17", 
         `Control Enhancement` == '1')
```

**Most important related controls - by count / frequency**

Should it be organized by Control Enhancement? or the overall most important related controls?
```{r}
#Controls4

CountRC <- Controls4 %>%
  group_by(`Related Controls`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

CountRC

#TESTING
#Number of Related Controls when Related Controls = "AU-12"? 
#Answer = 13
Controls4 %>%
  filter(`Related Controls` == 'AU-12')


##Organized by Control Enhancement (so broken down even farther)
CountRC_co <- Controls4 %>%
  group_by(`Control Enhancement`, `Related Controls`) %>%
  summarise(n_RelatedControls = n()) %>%
  arrange(desc(n_RelatedControls))

CountRC_co

#TESTING
#Number of Related Controls when Related Controls = "AU-12" and Control Enhancement = "1"? 
#Answer = 6
Controls4 %>%
  filter(`Related Controls` == 'AU-12', 
         `Control Enhancement` == '1')

```

```{r}
ggplot(CountRC,
       aes(`Related Controls`, n_RelatedControls)) + 
  geom_smooth()
```


**Most important related controls - by co-occurence** 
```{r}
#Controls4

#for ()
#if ()
```

**Most important subcontrols - by count of related controls and co-occurrence**  
```{r}
#Controls4

##By count of related controls 
CountCE <- Controls4 %>%
  group_by(`Main Control`, `Control Enhancement`) %>%
  summarise(n_ControlEnhancements = n()) %>%
  arrange(desc(n_ControlEnhancements))

CountCE

#TESTING
#Number of Related Controls when Main Control = "CM-8" and Control Enhancement = "3"? 
#Answer = 8
Controls4 %>%
  filter(`Main Control` == 'CM-8', 
         `Control Enhancement` == '3')

##By co-occurence

```

**Most important control families - by count of related controls / ratio of subcontrols**
```{r}
#Controls4

##By count of related controls 
CountCF <- Controls4 %>%
  group_by(`Control Family`) %>%
  summarise(n_ControlFamily = n()) %>%
  arrange(desc(n_ControlFamily))

CountCF

#TESTING
#Number of Related Controls when Control Family = "AC"? 
#Answer = 65
Controls4 %>%
  filter(`Control Family` == 'AC')


##By ratio of subcontrols 
CountCFRatio <- Controls4 %>%
  mutate(n_TotalControlEnhancement = n_distinct(`Main Control`, `Control Enhancement`)) %>%
  group_by(`Control Family`) %>%
  mutate(n_ControlEnhancement_by_Fam = n_distinct(`Main Control`, `Control Enhancement`),
         Ratio_SubControls = n_ControlEnhancement_by_Fam/n_TotalControlEnhancement) %>% 
  arrange(desc(Ratio_SubControls))

CountCFRatio
```

```{r}
#ordered
ggplot(CountCF, 
       aes(reorder(`Control Family`, -n_ControlFamily), n_ControlFamily)) +
  geom_bar(stat = "identity") +
  ggtitle("Most Important Family Controls based on Number of Related Controls") +
  xlab("Control Family") + 
  ylab("Number of Related Controls")

#not ordered
ggplot(CountCF, 
       aes(`Control Family`, n_ControlFamily)) +
  geom_bar(stat = "identity") +
  ggtitle("Most Important Family Controls based on Number of Related Controls") +
  xlab("Control Family") + 
  ylab("Number of Related Controls")
```

```{r}
#ordered
Visual_CountCFRatio <- CountCFRatio %>%
  select(`Control Family`, `Ratio_SubControls`)
Visual_CountCFRatio
 
Visual_CountCFRatio %>%
  ggplot(aes(reorder(`Control Family`, -Ratio_SubControls), Ratio_SubControls)) +
    geom_bar(stat = "identity") +
    ggtitle("Most Important Family Controls based on the Ratio of Control Enhancements") +
    xlab("Control Family") + 
    ylab("Ratio of Control Enhancements")
```

